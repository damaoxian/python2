# SQL Copilot 项目流程图

## 🎯 项目整体架构图

```mermaid
graph TB
    A[用户] --> B[启动方式选择]
    B --> C[run.py 启动脚本]
    B --> D[main.py 主程序]
    B --> E[example.py 示例程序]
    
    C --> F[菜单选择]
    F --> G[运行示例]
    F --> H[交互式查询]
    F --> I[批量生成SQL]
    F --> J[评测SQL结果]
    
    D --> K[命令行参数解析]
    K --> L[generate 模式]
    K --> M[evaluate 模式]
    K --> N[full 模式]
    K --> O[interactive 模式]
    
    E --> P[示例演示]
```

## 🔧 核心模块流程图

```mermaid
graph TB
    A[config.py 配置管理] --> B[API密钥配置]
    A --> C[数据库配置]
    A --> D[模型参数配置]
    A --> E[文件路径配置]
    
    F[utils.py 工具函数] --> G[SQL代码提取]
    F --> H[文件操作]
    F --> I[数据格式化]
    F --> J[进度显示]
    
    K[sql_generator.py SQL生成] --> L[QwenTurboGenerator]
    K --> M[QwenCoderGenerator]
    K --> N[LocalQwenGenerator]
    K --> O[SQLGeneratorFactory]
    
    P[sql_evaluator.py SQL评测] --> Q[数据库连接]
    P --> R[SQL执行]
    P --> S[结果格式化]
    P --> T[错误处理]
```

## 🚀 主要业务流程

### 1. 项目启动流程

```mermaid
flowchart TD
    A[项目启动] --> B{选择启动方式}
    B -->|用户友好| C[run.py]
    B -->|命令行| D[main.py]
    B -->|学习示例| E[example.py]
    
    C --> F[检查依赖包]
    F --> G[检查配置文件]
    G --> H[显示菜单]
    H --> I[执行选择的操作]
    
    D --> J[解析命令行参数]
    J --> K{运行模式}
    K -->|generate| L[生成SQL]
    K -->|evaluate| M[评测SQL]
    K -->|full| N[完整流程]
    K -->|interactive| O[交互模式]
    
    E --> P[演示各种功能]
    P --> Q[单个查询示例]
    P --> R[批量查询示例]
    P --> S[SQL评测示例]
    P --> T[模型对比示例]
```

### 2. SQL生成流程

```mermaid
flowchart TD
    A[开始SQL生成] --> B[读取配置文件]
    B --> C[读取数据表描述]
    C --> D[读取查询问题]
    D --> E[选择模型类型]
    
    E --> F{模型类型}
    F -->|qwen_turbo| G[QwenTurboGenerator]
    F -->|qwen_coder| H[QwenCoderGenerator]
    F -->|local_qwen| I[LocalQwenGenerator]
    
    G --> J[构建提示词]
    H --> J
    I --> J
    
    J --> K[调用LLM API]
    K --> L[接收响应]
    L --> M[提取SQL代码]
    M --> N[返回SQL和耗时]
    
    N --> O{批量处理?}
    O -->|是| P[处理下一个查询]
    O -->|否| Q[保存结果]
    P --> J
    Q --> R[生成完成]
```

### 3. SQL评测流程

```mermaid
flowchart TD
    A[开始SQL评测] --> B[读取配置文件]
    B --> C[创建数据库连接]
    C --> D{连接成功?}
    D -->|否| E[连接失败，退出]
    D -->|是| F[读取SQL文件]
    
    F --> G[解析SQL语句]
    G --> H[执行SQL查询]
    H --> I{执行成功?}
    I -->|否| J[记录错误信息]
    I -->|是| K[获取查询结果]
    
    K --> L[格式化结果]
    L --> M[构建Markdown表格]
    M --> N[保存评测结果]
    
    J --> N
    N --> O{还有SQL?}
    O -->|是| G
    O -->|否| P[生成统计报告]
    P --> Q[评测完成]
```

### 4. 交互式模式流程

```mermaid
flowchart TD
    A[进入交互模式] --> B[选择模型]
    B --> C[创建生成器]
    C --> D[读取数据表描述]
    D --> E[等待用户输入]
    
    E --> F{用户输入}
    F -->|查询问题| G[生成SQL]
    F -->|help| H[显示帮助]
    F -->|quit| I[退出程序]
    
    G --> J[显示生成的SQL]
    J --> K{是否执行?}
    K -->|是| L[执行SQL]
    K -->|否| E
    
    L --> M{执行成功?}
    M -->|是| N[显示结果]
    M -->|否| O[显示错误]
    
    N --> E
    O --> E
    H --> E
```

## 📊 数据流图

```mermaid
graph LR
    A[配置文件<br/>config.py] --> B[数据表描述<br/>数据表字段说明-精简1.txt]
    A --> C[查询问题<br/>qa_list-*.txt]
    A --> D[数据库连接<br/>MySQL]
    
    B --> E[SQL生成器<br/>sql_generator.py]
    C --> E
    E --> F[LLM API<br/>DashScope]
    F --> G[生成的SQL]
    
    G --> H[SQL评测器<br/>sql_evaluator.py]
    D --> H
    H --> I[执行结果]
    I --> J[输出文件<br/>Excel格式]
```

## 🔄 模块依赖关系图

```mermaid
graph TD
    A[main.py 主程序] --> B[config.py 配置]
    A --> C[sql_generator.py 生成器]
    A --> D[sql_evaluator.py 评测器]
    A --> E[utils.py 工具函数]
    
    C --> B
    C --> E
    C --> F[LLM API]
    
    D --> B
    D --> E
    D --> G[数据库]
    
    H[run.py 启动脚本] --> A
    I[example.py 示例] --> C
    I --> D
    I --> B
    I --> E
    
    J[test_config.py 测试] --> B
    J --> C
    J --> D
```

## 🎯 关键决策点

```mermaid
flowchart TD
    A[项目启动] --> B{启动方式}
    B -->|run.py| C[菜单驱动]
    B -->|main.py| D[命令行驱动]
    B -->|example.py| E[示例演示]
    
    C --> F{用户选择}
    F -->|1| G[运行示例]
    F -->|2| H[交互式查询]
    F -->|3| I[批量生成]
    F -->|4| J[评测结果]
    F -->|5| K[查看帮助]
    F -->|6| L[退出]
    
    D --> M{运行模式}
    M -->|generate| N[仅生成SQL]
    M -->|evaluate| O[仅评测SQL]
    M -->|full| P[完整流程]
    M -->|interactive| Q[交互模式]
    
    N --> R[选择模型]
    O --> S[选择输入文件]
    P --> T[生成+评测]
    Q --> U[实时交互]
```

## 📈 性能优化流程

```mermaid
flowchart TD
    A[性能监控] --> B[响应时间统计]
    A --> C[成功率统计]
    A --> D[错误率统计]
    
    B --> E{响应时间}
    E -->|>5秒| F[优化模型参数]
    E -->|正常| G[继续监控]
    
    C --> H{成功率}
    H -->|<80%| I[调整提示词]
    H -->|正常| G
    
    D --> J{错误率}
    J -->|>20%| K[检查配置]
    J -->|正常| G
    
    F --> L[降低temperature]
    I --> M[优化表描述]
    K --> N[检查API密钥]
    
    L --> O[重新测试]
    M --> O
    N --> O
    O --> A
```

## 🛠️ 错误处理流程

```mermaid
flowchart TD
    A[错误发生] --> B{错误类型}
    B -->|配置错误| C[检查config.py]
    B -->|API错误| D[检查API密钥]
    B -->|数据库错误| E[检查数据库连接]
    B -->|模型错误| F[检查模型配置]
    
    C --> G[修正配置]
    D --> H[更新API密钥]
    E --> I[检查网络连接]
    F --> J[调整模型参数]
    
    G --> K[重新启动]
    H --> K
    I --> K
    J --> K
    
    K --> L{问题解决?}
    L -->|是| M[继续执行]
    L -->|否| N[记录错误日志]
    
    N --> O[用户反馈]
    O --> P[技术支持]
```

## 📋 总结

SQL Copilot项目采用了模块化设计，主要包含以下核心组件：

1. **配置管理** (config.py) - 统一管理所有配置信息
2. **SQL生成** (sql_generator.py) - 支持多种LLM模型的SQL生成
3. **SQL评测** (sql_evaluator.py) - 执行SQL并评测结果
4. **工具函数** (utils.py) - 提供通用功能支持
5. **主程序** (main.py) - 命令行接口
6. **启动脚本** (run.py) - 用户友好的菜单界面
7. **示例程序** (example.py) - 功能演示

项目支持多种使用方式，具有良好的扩展性和维护性，能够适应不同的业务场景需求。
