# SQL Copilot 使用指南 - 新业务场景适配

## 📋 目录

1. [项目概述](#项目概述)
2. [新业务场景适配步骤](#新业务场景适配步骤)
3. [数据表结构修改](#数据表结构修改)
4. [配置文件调整](#配置文件调整)
5. [查询问题定制](#查询问题定制)
6. [模型参数调优](#模型参数调优)
7. [测试和验证](#测试和验证)
8. [常见问题解决](#常见问题解决)
9. [最佳实践](#最佳实践)

## 🎯 项目概述

SQL Copilot 是一个基于大语言模型的Text2SQL工具，能够将自然语言查询转换为SQL语句。本指南将详细说明如何将项目适配到新的业务场景中。

## 🔧 新业务场景适配步骤

### 第一步：分析新业务需求

在开始适配之前，需要明确以下信息：

1. **业务领域**：电商、金融、医疗、教育等
2. **数据表结构**：表名、字段名、数据类型、关系
3. **查询类型**：统计分析、报表生成、数据挖掘等
4. **用户群体**：业务人员、数据分析师、开发人员等

### 第二步：准备数据文件

#### 2.1 数据表结构文件

创建新的数据表结构文件，替换 `insurance/data/create_sql.txt`：

```sql
-- 新业务数据表结构示例（电商场景）
CREATE TABLE users (
    user_id INT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    registration_date DATE,
    user_status VARCHAR(20)
);

CREATE TABLE products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(100),
    category VARCHAR(50),
    price DECIMAL(10,2),
    stock_quantity INT,
    created_date DATE
);

CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    user_id INT,
    product_id INT,
    order_date DATE,
    quantity INT,
    total_amount DECIMAL(10,2),
    order_status VARCHAR(20)
);
```

#### 2.2 数据表字段说明

更新 `insurance/data/数据表字段说明-精简1.txt`：

```
用户表（users）：用户ID（user_id）、用户名（username）、邮箱（email）、电话（phone）、注册日期（registration_date）、用户状态（user_status）

商品表（products）：商品ID（product_id）、商品名称（product_name）、分类（category）、价格（price）、库存数量（stock_quantity）、创建日期（created_date）

订单表（orders）：订单ID（order_id）、用户ID（user_id）、商品ID（product_id）、订单日期（order_date）、数量（quantity）、总金额（total_amount）、订单状态（order_status）
```

#### 2.3 示例数据文件

准备Excel格式的示例数据文件：
- `users.xlsx` - 用户数据
- `products.xlsx` - 商品数据  
- `orders.xlsx` - 订单数据

### 第三步：修改配置文件

#### 3.1 更新数据库配置

修改 `config.py` 中的数据库配置：

```python
# 数据库配置
self.db_host = os.getenv('DB_HOST', 'your-new-host')
self.db_user = os.getenv('DB_USER', 'your-new-username')
self.db_password = os.getenv('DB_PASSWORD', 'your-new-password')
self.db_name = os.getenv('DB_NAME', 'your-new-database')
```

#### 3.2 更新文件路径配置

```python
# 文件路径配置
self.data_dir = './your-business/data'  # 修改为新的业务目录
self.table_description_file = f'{self.data_dir}/数据表字段说明-精简1.txt'
self.create_sql_file = f'{self.data_dir}/create_sql.txt'
self.qa_list_1_file = './your-business/qa_list-1.txt'
self.qa_list_2_file = './your-business/qa_list-2.txt'
```

### 第四步：定制查询问题

#### 4.1 创建业务相关的查询问题

更新 `qa_list-1.txt` 和 `qa_list-2.txt`：

```
查询所有用户的注册信息
=====
统计每个分类的商品数量
=====
查询最近30天的订单总额
=====
找出购买金额最高的前10个用户
=====
分析每个月的销售趋势
=====
查询库存不足的商品
=====
统计不同状态订单的数量分布
=====
查询用户的平均订单金额
=====
找出最受欢迎的商品类别
=====
查询用户的复购率
```

#### 4.2 查询问题分类

将查询问题按业务场景分类：

**基础查询类**：
- 单表查询
- 条件筛选
- 排序和分组

**统计分析类**：
- 聚合函数
- 趋势分析
- 对比分析

**业务分析类**：
- 用户行为分析
- 销售数据分析
- 库存管理分析

### 第五步：调整模型参数

#### 5.1 根据业务特点调整参数

```python
# 在 config.py 中调整参数
self.temperature = 0.1  # 降低随机性，提高准确性
self.max_tokens = 1500  # 增加令牌数，支持复杂查询
```

#### 5.2 选择适合的模型

- **简单查询**：使用 `qwen_turbo`
- **复杂分析**：使用 `qwen_coder-plus`
- **本地部署**：使用 `local_qwen`

### 第六步：测试和验证

#### 6.1 运行配置测试

```bash
python test_config.py
```

#### 6.2 测试单个查询

```bash
python main.py --interactive
```

#### 6.3 批量测试

```bash
python main.py --mode generate --model qwen_turbo
```

#### 6.4 验证SQL执行

```bash
python main.py --mode evaluate
```

## 📊 数据表结构修改

### 表结构设计原则

1. **命名规范**：使用有意义的表名和字段名
2. **数据类型**：选择合适的数据类型
3. **主键设计**：确保唯一性和性能
4. **外键关系**：建立正确的表关系
5. **索引优化**：为常用查询字段建立索引

### 常见业务场景表结构

#### 电商场景
```sql
-- 用户表
CREATE TABLE users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    registration_date DATE,
    user_status ENUM('active', 'inactive', 'banned')
);

-- 商品表
CREATE TABLE products (
    product_id INT PRIMARY KEY AUTO_INCREMENT,
    product_name VARCHAR(100) NOT NULL,
    category_id INT,
    price DECIMAL(10,2) NOT NULL,
    stock_quantity INT DEFAULT 0,
    created_date DATE,
    status ENUM('active', 'inactive', 'discontinued')
);

-- 订单表
CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    order_date DATETIME,
    total_amount DECIMAL(10,2),
    order_status ENUM('pending', 'paid', 'shipped', 'delivered', 'cancelled'),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

#### 金融场景
```sql
-- 客户表
CREATE TABLE customers (
    customer_id INT PRIMARY KEY AUTO_INCREMENT,
    customer_name VARCHAR(100) NOT NULL,
    id_number VARCHAR(18) UNIQUE,
    phone VARCHAR(20),
    email VARCHAR(100),
    registration_date DATE,
    customer_type ENUM('individual', 'enterprise')
);

-- 账户表
CREATE TABLE accounts (
    account_id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT,
    account_type ENUM('savings', 'checking', 'credit'),
    balance DECIMAL(15,2) DEFAULT 0,
    created_date DATE,
    status ENUM('active', 'frozen', 'closed'),
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
);

-- 交易表
CREATE TABLE transactions (
    transaction_id INT PRIMARY KEY AUTO_INCREMENT,
    account_id INT,
    transaction_type ENUM('deposit', 'withdrawal', 'transfer'),
    amount DECIMAL(15,2),
    transaction_date DATETIME,
    description TEXT,
    FOREIGN KEY (account_id) REFERENCES accounts(account_id)
);
```

## ⚙️ 配置文件调整

### 数据库连接配置

```python
# 生产环境配置
self.db_host = "production-db-host"
self.db_user = "production-user"
self.db_password = "secure-password"
self.db_name = "production-database"
self.db_charset = "utf8mb4"

# 开发环境配置
self.db_host = "localhost"
self.db_user = "dev-user"
self.db_password = "dev-password"
self.db_name = "dev-database"
```

### API配置

```python
# 不同环境的API配置
if os.getenv('ENVIRONMENT') == 'production':
    self.dashscope_api_key = "production-api-key"
    self.temperature = 0.1
    self.max_tokens = 2000
else:
    self.dashscope_api_key = "development-api-key"
    self.temperature = 0.3
    self.max_tokens = 1000
```

### 文件路径配置

```python
# 根据业务类型配置路径
business_type = os.getenv('BUSINESS_TYPE', 'insurance')

if business_type == 'ecommerce':
    self.data_dir = './ecommerce/data'
    self.table_description_file = f'{self.data_dir}/电商数据表字段说明.txt'
elif business_type == 'finance':
    self.data_dir = './finance/data'
    self.table_description_file = f'{self.data_dir}/金融数据表字段说明.txt'
else:
    self.data_dir = './insurance/data'
    self.table_description_file = f'{self.data_dir}/数据表字段说明-精简1.txt'
```

## 🔍 查询问题定制

### 查询问题设计原则

1. **业务相关性**：问题应该反映实际业务需求
2. **难度梯度**：从简单到复杂，循序渐进
3. **覆盖全面**：涵盖不同的查询类型
4. **实用性强**：问题应该在实际工作中有用

### 查询问题模板

#### 基础查询模板
```
查询所有[表名]的[字段名]
=====
查询[条件]的[表名]信息
=====
统计[表名]中[字段名]的[统计函数]
=====
```

#### 关联查询模板
```
查询[表1]和[表2]的关联信息
=====
统计每个[分组字段]的[统计字段]
=====
查询[条件]的[表1]及其关联的[表2]信息
=====
```

#### 业务分析模板
```
分析[业务指标]的[时间维度]趋势
=====
找出[业务指标]最高/最低的[对象]
=====
计算[业务指标]的[统计维度]分布
=====
```

### 查询问题示例

#### 电商业务查询
```
查询所有用户的注册信息
=====
统计每个商品分类的销售数量
=====
查询最近30天的订单总额
=====
找出购买金额最高的前10个用户
=====
分析每个月的销售趋势
=====
查询库存不足的商品
=====
统计不同状态订单的数量分布
=====
查询用户的平均订单金额
=====
找出最受欢迎的商品类别
=====
查询用户的复购率
```

#### 金融业务查询
```
查询所有客户的基本信息
=====
统计每个账户类型的客户数量
=====
查询最近一年的交易总额
=====
找出余额最高的前10个账户
=====
分析每个月的存款趋势
=====
查询异常交易记录
=====
统计不同交易类型的金额分布
=====
查询客户的平均账户余额
=====
找出最活跃的客户
=====
查询客户的信用评级分布
```

## 🎛️ 模型参数调优

### 温度参数调优

```python
# 不同场景的温度参数建议
if business_type == 'financial':
    # 金融场景需要高准确性
    self.temperature = 0.1
elif business_type == 'creative':
    # 创意场景需要更多变化
    self.temperature = 0.7
else:
    # 一般业务场景
    self.temperature = 0.3
```

### 最大令牌数调优

```python
# 根据查询复杂度调整
if query_complexity == 'simple':
    self.max_tokens = 500
elif query_complexity == 'medium':
    self.max_tokens = 1000
else:
    self.max_tokens = 2000
```

### 模型选择策略

```python
def select_model(business_type, query_complexity):
    """根据业务类型和查询复杂度选择模型"""
    if business_type == 'financial' and query_complexity == 'high':
        return 'qwen-coder-plus'  # 高精度模型
    elif business_type == 'ecommerce' and query_complexity == 'medium':
        return 'qwen-turbo'  # 平衡模型
    else:
        return 'qwen-turbo'  # 默认模型
```

## 🧪 测试和验证

### 测试流程

1. **配置测试**：验证数据库连接和API配置
2. **功能测试**：测试SQL生成和评测功能
3. **性能测试**：测试响应时间和准确性
4. **业务测试**：验证业务场景的适用性

### 测试脚本

```python
# 创建业务特定的测试脚本
def test_business_scenario():
    """测试特定业务场景"""
    # 测试基础查询
    test_basic_queries()
    
    # 测试复杂查询
    test_complex_queries()
    
    # 测试业务分析
    test_business_analysis()
    
    # 测试性能
    test_performance()
```

### 验证标准

1. **准确性**：SQL语法正确，逻辑合理
2. **完整性**：查询结果完整，无遗漏
3. **性能**：响应时间在可接受范围内
4. **稳定性**：长时间运行稳定可靠

## ❓ 常见问题解决

### 问题1：SQL生成不准确

**原因分析**：
- 数据表描述不清晰
- 查询问题表述不明确
- 模型参数设置不当

**解决方案**：
1. 优化数据表描述文件
2. 改进查询问题表述
3. 调整模型参数
4. 增加示例查询

### 问题2：数据库连接失败

**原因分析**：
- 数据库配置错误
- 网络连接问题
- 权限不足

**解决方案**：
1. 检查数据库配置
2. 测试网络连接
3. 验证用户权限
4. 检查防火墙设置

### 问题3：模型响应慢

**原因分析**：
- API限制
- 网络延迟
- 模型负载高

**解决方案**：
1. 优化查询问题长度
2. 调整模型参数
3. 使用本地模型
4. 增加重试机制

### 问题4：查询结果不准确

**原因分析**：
- 数据表关系理解错误
- 业务逻辑理解偏差
- 查询条件不完整

**解决方案**：
1. 完善数据表描述
2. 增加业务规则说明
3. 提供更多示例
4. 人工审核和修正

## 🏆 最佳实践

### 1. 数据表设计最佳实践

- 使用有意义的表名和字段名
- 建立合适的主键和外键关系
- 为常用查询字段建立索引
- 使用合适的数据类型

### 2. 查询问题设计最佳实践

- 问题表述清晰明确
- 覆盖不同的查询类型
- 从简单到复杂循序渐进
- 包含实际业务场景

### 3. 模型配置最佳实践

- 根据业务特点选择模型
- 调整参数以适应业务需求
- 定期评估和优化配置
- 建立监控和告警机制

### 4. 测试和部署最佳实践

- 建立完整的测试流程
- 使用版本控制管理配置
- 建立回滚机制
- 定期备份和恢复

### 5. 维护和优化最佳实践

- 定期收集用户反馈
- 持续优化模型参数
- 更新数据表描述
- 扩展查询问题库

## 📞 技术支持

如果在适配过程中遇到问题，可以通过以下方式获取帮助：

1. **查看文档**：仔细阅读项目文档
2. **运行测试**：使用测试脚本验证配置
3. **查看日志**：分析错误日志信息
4. **社区支持**：在项目社区寻求帮助
5. **专业支持**：联系技术支持团队

---

**注意**：本指南提供了通用的适配方法，具体实施时需要根据实际业务场景进行调整和优化。
